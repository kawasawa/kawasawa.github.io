<!-- Generated by GitHub Copilot -->

# MCP Knowledge Server

> [!NOTE]
> このドキュメントは GitHub Copilot が生成しました。

## 🚀 概要

MCP Knowledge Server は、ワークスペース内のコメントを検索・提供する Model Context Protocol (MCP) サーバです。このサーバにより、ワークスペース内のソースコードやスクリプトに含まれる指定のアノテーションコメントタグで始まるコメントを検索し、生成 AI が技術的な情報源として活用できるようになります。

## ✨ 特徴

- **キーワード検索**: 指定のフレーズでコメントを全文検索
- **セマンティック検索**: 日本語対応の多言語ベクトルモデルを使用した意味ベースの検索
- **全件取得**: ワークスペース内のアノテーションコメントを一覧表示
- **キャッシュ機能**: ベクトル化データのキャッシュによる高速化
- **多言語対応**: 様々なプログラミング言語のコメント形式に対応
- **VS Code 統合**: GitHub Copilot など生成 AI との自動連携

## 🛠 使用方法

### 1. VS Code から MCP サーバとして使用し、生成 AI で活用（推奨）

`.vscode/mcp.json` に以下の設定を追加：

```json
{
  "servers": {
    "knowledge": {
      "command": "${workspaceFolder}/mcp/knowledge/run.sh",
      "args": ["--workspace", "${workspaceFolder}"]
    }
  }
}
```

VS Code で生成 AI を使用する際に、自動的にコメントが参照可能になります。  
GitHub Copilot に以下のような質問をしてみてください：

例：

- 「React で useEffect を使う際の注意点は？」 → React 副作用に関する注意点の情報が参照される
- 「セキュリティ対策で気をつけることは？」 → XSS、CSRF、CORS に関する具体的な対策情報が参照される
- 「AWS のセキュリティグループってどう設定するの？」 → Terraform ファイル内の実際の設定知見が参照される
- 「MySQL の文字コード設定について教えて」 → 設定ファイル内の推奨設定と理由が参照される

セキュリティ学習、React 開発、AWS 構築などへの活用が期待できます。

### 2. 直接実行

直接ソースを実行することもできます。

- デフォルト設定で起動

```bash
cd ~/repos/kawasawa.github.io/mcp/knowledge
python3 main.py --workspace ~/repos/kawasawa.github.io
```

- アノテーションタグを変更して起動

```bash
cd ~/repos/kawasawa.github.io/mcp/knowledge
python3 main.py --workspace ~/repos/kawasawa.github.io --annotation_tag "HACK:"
```

- 起動した MCP サーバに JSON-RPC 形式のリクエストを送信

```bash
cd ~/repos/kawasawa.github.io/mcp/knowledge
echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"search_knowledge","arguments":{"search_phrase":"React"}}}' | python3 main.py --workspace ~/repos/kawasawa.github.io
```

## 🔧 利用可能なツール

### search_knowledge

指定のフレーズでコメントを検索します。

**パラメータ:**

- `search_phrase` (string): 検索フレーズ
- `use_semantic_search` (boolean): 意味ベースの検索を行うかどうか
- `limit` (integer): 意味ベースの検索で返す結果の最大数
- `similarity_threshold` (number): 意味ベースの検索での類似度閾値

**例:**

```json
{
  "name": "search_knowledge",
  "arguments": {
    "search_phrase": "セキュリティ"
  }
}
```

### list_all_knowledge

ワークスペース内の対象の全コメントを一覧表示します。

**パラメータ:** なし

### clear_cache

ベクトルデータのキャッシュを削除します。

**パラメータ:** なし

## ⚙️ 技術仕様

- **プロトコル**: Model Context Protocol (MCP) 2024-11-05
- **Python バージョン**: 3.10 以上
- **文字エンコーディング**: UTF-8

### アーキテクチャ

**検索方式の自動選択:**

- ベクトル検索が利用可能な場合: ベクトル検索を実行
- ベクトル検索が利用不可な場合: 全文検索にフォールバック
- ユーザが明示的に指定した場合: 指定された方式を使用

### 検索性能の比較

| 検索方式     | 完全一致 | 部分一致 | 意味一致 | 日本語対応 | 速度 |
| ------------ | -------- | -------- | -------- | ---------- | ---- |
| ベクトル検索 | ✅       | ✅       | ✅       | ✅         | 中   |
| テキスト検索 | ✅       | ✅       | ❌       | ✅         | 高   |

**推奨**: 基本的にベクトル検索を使用し、高速検索が必要な場合のみキーワード検索を使用

### パフォーマンス指標

- **初回初期化**: 3-5 分（モデルダウンロード + ベクトル化）
- **2 回目以降起動**: 数秒（キャッシュ利用）
- **検索速度**: 数百ミリ秒
- **メモリ使用量**: 約 1-2GB（モデル + ベクトルデータ）

### 類似度計算

- **手法**: コサイン類似度
- **閾値**: 0.3（デフォルト）
- **スコア範囲**: 0.0（無関係）〜 1.0（完全一致）

### キャッシュシステム

- **ファイル**: `.vector_cache.pkl`（ワークスペースルート）
- **形式**: Python pickle 形式
- **内容**: ベクトル化されたコメントデータ、メタデータ
- **更新条件**: コメント数の変化を検出時

### 制限事項

- バイナリファイルは検索対象外
- 大きなファイル（例: ログファイル）は処理が遅くなる可能性があります
- ファイル読み込みエラーは無視され、該当ファイルはスキップされます

## 🚨 トラブルシューティング

### 初期化時にエラーが発生

- **症状**: 初期化時にエラーが発生
- **対処法**:
  - 依存関係が正しくインストールされているか確認
  - インターネット接続を確認（初回はモデルダウンロードが必要）
  - `.tool-versions` で指定されたバージョンの Python3 を使用しているか確認
  - メモリの空き容量を確認（不要なアプリケーションを終了、対象ファイルが多い場合はアノテーションタグを変更）

### 検索結果が期待と異なる

- **症状**: セマンティック検索の結果が意図と異なる
- **対処法**:
  - `search_phrase` を変更してみる
  - `use_semantic_search` を `false` に変更してみる（キーワード検索と比較）
  - `limit` の値を調整（5〜20 程度）
  - `similarity_threshold` を調整（0.2〜0.5 程度）

### キャッシュ関連の問題

- **症状**: 新しいコメントが検索結果に反映されない
- **対処法**:
  - `clear_cache` ツールでキャッシュをクリア
  - `.vector_cache.pkl` ファイルを手動削除
  - サーバを再起動して再初期化

## 📄 ライセンス

このプロジェクトのライセンスについては、ワークスペースのルートディレクトリにある `LICENSE.md` を参照してください。
